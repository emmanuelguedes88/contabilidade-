<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meu Or√ßamento PRO</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Poppins', sans-serif; background-color:#111827; color:#e5e7eb; -webkit-tap-highlight-color: transparent; }
.hidden { display: none !important; }
.fade-in { animation: fadeIn 0.5s ease-out forwards; }
@keyframes fadeIn { from {opacity:0; transform:translateY(-15px) scale(0.95);} to {opacity:1; transform:translateY(0) scale(1);} }
.glass-card { background: rgba(31,41,55,0.6); backdrop-filter: blur(20px); border:1px solid rgba(255,255,255,0.1); box-shadow:0 8px 32px 0 rgba(0,0,0,0.37); }
.btn-glow { transition: all 0.3s ease; position: relative; overflow: hidden; }
.btn-glow:hover:not(:disabled) { box-shadow: 0 0 15px 5px rgba(16,185,129,0.5); transform: translateY(-2px);}
.btn-glow:disabled { opacity: 0.5; cursor: not-allowed; }
input, select { background-color: rgba(17,24,39,0.5); border:1px solid rgba(255,255,255,0.2); color:#fff; }
input:focus, select:focus { outline:none; border-color:#14b8a6; box-shadow:0 0 10px 2px rgba(20,184,166,0.5);}
.icon-btn { background:transparent; border:none; color:#9ca3af; transition: color 0.2s; }
.icon-btn:hover { color: #ef4444; }
.icon-btn.view:hover { color: #34d399; }
.password-toggle-btn { position: absolute; inset-y: 0; right: 0; padding-left: 0.75rem; padding-right: 0.75rem; display: flex; align-items: center; color: #9ca3af; transition: color 0.2s; }
.password-toggle-btn:hover { color: #fff; }
</style>
</head>
<body>

<!-- Loader Inicial -->
<div id="initialLoader" class="fixed inset-0 bg-[#111827] flex flex-col items-center justify-center z-50">
  <svg class="animate-spin h-10 w-10 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
</div>

<!-- Conte√∫do da Aplica√ß√£o -->
<div id="authContainer"></div>
<div id="appContainer" class="hidden">
  <header class="sticky top-0 z-30 bg-gray-900/50 backdrop-blur-lg p-4 flex justify-between items-center"><div class="flex items-center space-x-3"><span class="h-10 w-10 rounded-full border-2 border-cyan-400 flex items-center justify-center text-2xl">üöÄ</span><h1 class="text-2xl font-bold text-white tracking-wider">Meu Or√ßamento</h1></div><div class="flex items-center"><span id="userEmail" class="text-gray-400 text-sm hidden sm:block mr-4"></span><button data-action="logout" class="rounded-full bg-red-500/80 py-2 px-4 text-sm font-semibold text-white btn-glow">Sair</button></div></header>
  <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Filtros e Resumo -->
    <div class="mb-8 space-y-6">
      <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4 glass-card p-3 rounded-2xl">
        <label for="month-filter" class="font-semibold text-gray-300">Ver Or√ßamento de:</label>
        <select id="month-filter" class="p-2 border-none rounded-lg"></select>
        <select id="year-filter" class="p-2 border-none rounded-lg"></select>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="glass-card p-5 rounded-2xl flex items-center space-x-4"><div class="bg-green-500/20 p-3 rounded-full"><span class="text-3xl">üí∞</span></div><div><p class="text-sm text-gray-400">Receita do M√™s</p><p id="summaryIncome" class="text-2xl font-bold text-green-400">R$ 0,00</p></div></div><div class="glass-card p-5 rounded-2xl flex items-center space-x-4"><div class="bg-red-500/20 p-3 rounded-full"><span class="text-3xl">üí∏</span></div><div><p class="text-sm text-gray-400">Despesa do M√™s</p><p id="summaryExpense" class="text-2xl font-bold text-red-400">R$ 0,00</p></div></div><div class="glass-card p-5 rounded-2xl flex items-center space-x-4"><div class="bg-cyan-500/20 p-3 rounded-full"><span class="text-3xl">üè¶</span></div><div><p class="text-sm text-gray-400">Saldo do M√™s</p><p id="summaryBalance" class="text-2xl font-bold text-cyan-400">R$ 0,00</p></div></div></div>
    </div>
    
    <!-- Container do Gr√°fico -->
    <div class="mb-8 glass-card p-4 rounded-2xl">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white">An√°lise do M√™s</h3>
        </div>
        <div class="h-64 sm:h-80">
            <canvas id="financeChart"></canvas>
        </div>
    </div>

    <!-- Bot√µes de A√ß√£o Principal -->
    <div class="mb-8 grid grid-cols-1 sm:grid-cols-2 gap-4"><button data-action="show-income-modal" class="w-full flex items-center justify-center space-x-3 bg-green-500 text-white font-bold py-3 px-4 rounded-xl btn-glow text-lg"><span class="text-2xl">‚ûï</span><span>Adicionar Receita</span></button><button data-action="add-salary" class="w-full flex items-center justify-center space-x-3 bg-green-700 text-white font-bold py-3 px-4 rounded-xl btn-glow text-lg"><span class="text-2xl">üíº</span><span>Adicionar Sal√°rio</span></button></div>
    <!-- Adi√ß√£o R√°pida de Despesa -->
    <div class="mb-8">
      <h3 class="text-xl font-bold text-white mb-4">Adicionar Despesas</h3>
      <div id="quick-add-container" class="grid grid-cols-3 sm:grid-cols-5 md:grid-cols-7 lg:grid-cols-10 gap-4"></div>
    </div>
    
    <!-- Se√ß√µes de Resumo e Hist√≥rico separadas -->
    <div>
        <h2 class="text-xl font-bold mb-4 text-white">Resumo de Despesas do M√™s</h2>
        <div id="categorySummary" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-6">
            <p id="no-summary-msg" class="text-gray-500 text-center py-4 col-span-full">Nenhuma despesa para resumir este m√™s.</p>
        </div>

        <h2 class="text-xl font-bold mb-4 text-white">Hist√≥rico Detalhado do M√™s</h2>
        <div id="transactionHistory" class="space-y-3">
            <p id="no-transactions-msg" class="text-gray-500 text-center py-4">Nenhuma transa√ß√£o registada neste m√™s.</p>
        </div>
    </div>
  </main>
</div>
<!-- Container para "P√°ginas" de Modais (Supermercado, Transa√ß√£o) -->
<div id="modalPageContainer" class="hidden"></div>
<!-- Container para Modais de Confirma√ß√£o e Termos -->
<div id="modalContainer"></div>

<script type="module">
// --- C√ìDIGO DA APLICA√á√ÉO ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Configura√ß√£o do Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCxNNygCvK2xQeIymAZoo95ydb2l9l7O6E",
  authDomain: "financeiro-ab215.firebaseapp.com",
  projectId: "financeiro-ab215",
  storageBucket: "financeiro-ab215.firebasestorage.app",
  messagingSenderId: "1074139488619",
  appId: "1:1074139488619:web:4aee186cd13735839cec2e",
  measurementId: "G-SDTX2HMTHX"
};

let auth, db;
try {
  const app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
} catch (e) { console.error("Firebase initialization failed:", e); }

let monthFilter, yearFilter, transactionHistory, summaryIncome, summaryExpense, summaryBalance, quickAddContainer, noTransactionsMsg;
let categorySummary, noSummaryMsg;
const modalContainer = document.getElementById('modalContainer');
const modalPageContainer = document.getElementById('modalPageContainer'); 
let financeChartInstance = null;

const quickAddItems = [ 
    { name: 'Supermercado', icon: 'üõí', type: 'despesa', action: 'quick-expense', entryType: 'full' }, 
    { name: 'Aluguel', icon: 'üè†', type: 'despesa', action: 'quick-expense', entryType: 'simple' }, 
    { name: 'Energia', icon: 'üí°', type: 'despesa', action: 'quick-expense', entryType: 'simple' }, 
    { name: '√Ågua', icon: 'üíß', type: 'despesa', action: 'quick-expense', entryType: 'simple' }, 
    { name: 'Internet', icon: 'üåê', type: 'despesa', action: 'quick-expense', entryType: 'simple' }, 
    { name: 'Cart√µes', icon: 'üí≥', type: 'despesa', action: 'quick-expense', entryType: 'simple' },
    { name: 'Combust√≠vel', icon: '‚õΩ', type: 'despesa', action: 'quick-expense', entryType: 'simple' }, 
    { name: 'Farm√°cia', icon: 'üíä', type: 'despesa', action: 'quick-expense', entryType: 'simple' }, 
    { name: 'Lazer', icon: 'üéâ', type: 'despesa', action: 'quick-expense', entryType: 'simple' }, 
    { name: 'Sa√∫de', icon: '‚ù§Ô∏è', type: 'despesa', action: 'quick-expense', entryType: 'simple' }, 
    { name: 'Educa√ß√£o', icon: 'üéì', type: 'despesa', action: 'quick-expense', entryType: 'simple' }, 
    { name: 'Comida', icon: 'üçï', type: 'despesa', action: 'quick-expense', entryType: 'full' }, 
    { name: 'Celular', icon: 'üì±', type: 'despesa', action: 'quick-expense', entryType: 'simple' },
    { name: 'Netflix', icon: 'üé¨', type: 'despesa', action: 'quick-expense', entryType: 'simple' },
    { name: 'YouTube', icon: '‚ñ∂Ô∏è', type: 'despesa', action: 'quick-expense', entryType: 'simple' },
    { name: 'Carro', icon: 'üöó', type: 'despesa', action: 'quick-expense', entryType: 'simple' },
    { name: 'Outro', icon: '‚öôÔ∏è', type: 'despesa', action: 'quick-expense', entryType: 'simple' } 
];

// Nova fun√ß√£o para buscar √≠cones
function getIconForCategory(categoryName) {
    const item = quickAddItems.find(i => i.name === categoryName);
    if (item) {
        return item.icon;
    }
    // Fallback para nomes customizados (como de 'Outro')
    const salarioItem = categoryName === 'Sal√°rio' ? 'üíº' : null;
    if (salarioItem) return salarioItem;

    const outroItem = quickAddItems.find(i => i.name === 'Outro');
    return outroItem ? outroItem.icon : 'üí∏'; // Icone gen√©rico de despesa
}


function initializeAppDOMElements() {
    monthFilter = document.getElementById('month-filter');
    yearFilter = document.getElementById('year-filter');
    transactionHistory = document.getElementById('transactionHistory');
    summaryIncome = document.getElementById('summaryIncome');
    summaryExpense = document.getElementById('summaryExpense');
    summaryBalance = document.getElementById('summaryBalance');
    quickAddContainer = document.getElementById('quick-add-container');
    noTransactionsMsg = document.getElementById('no-transactions-msg');
    
    categorySummary = document.getElementById('categorySummary');
    noSummaryMsg = document.getElementById('no-summary-msg');
}

// --- Fun√ß√µes de UI e Autentica√ß√£o ---
const eyeIconSvg = `<svg data-icon="eye" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`;
const eyeOffIconSvg = `<svg data-icon="eye-off" class="h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19.5c-4.638 0-8.573-3.007-9.963-7.178a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c1.192 0 2.337.163 3.425.445M15 12a3 3 0 11-6 0 3 3 0 016 0zm-4.75 4.75L4.5 19.5m15-6l-2.25 2.25M4.5 4.5l15 15"></path></svg>`;

function showApp(user){ 
    document.getElementById('initialLoader').classList.add('hidden'); 
    document.getElementById('authContainer').innerHTML=''; 
    document.getElementById('authContainer').classList.add('hidden'); 
    document.getElementById('modalPageContainer').innerHTML = '';
    document.getElementById('modalPageContainer').classList.add('hidden');
    document.getElementById('appContainer').classList.remove('hidden'); 
    document.getElementById('userEmail').textContent = user.email; 
}
function showAuth(){ 
    document.getElementById('initialLoader').classList.add('hidden'); 
    document.getElementById('appContainer').classList.add('hidden'); 
    document.getElementById('modalPageContainer').innerHTML = '';
    document.getElementById('modalPageContainer').classList.add('hidden');
    document.getElementById('authContainer').classList.remove('hidden'); 
    
    document.getElementById('authContainer').innerHTML = `<div class="p-8 max-w-md mx-auto mt-20 glass-card rounded-xl fade-in">
        <div class="text-center mb-6"><h1 class="text-3xl font-bold text-white">Or√ßamento Familiar</h1><p class="text-cyan-400">Controle as suas finan√ßas com facilidade</p></div>
        <input type="email" id="loginEmail" placeholder="Email" class="w-full mb-3 p-2 rounded-lg">
        <div class="relative"> 
            <input type="password" id="loginPass" placeholder="Senha" class="w-full p-2 rounded-lg pr-10">
            <button type="button" data-action="toggle-password" data-target="loginPass" class="password-toggle-btn">${eyeIconSvg}${eyeOffIconSvg}</button>
        </div>
        <p class="text-sm text-right text-gray-400 hover:text-cyan-400 cursor-pointer mt-4 mb-4" id="showForgotPassword">Esqueceu a senha?</p>
        <p id="loginError" class="text-red-400 text-center text-sm mb-4 h-5"></p>
        <button id="loginBtn" class="w-full bg-green-500 py-2 rounded-lg font-bold btn-glow">Entrar</button>
        <p class="text-sm mt-3 text-center text-gray-400">N√£o tem uma conta? <span id="showSignup" class="text-cyan-400 cursor-pointer font-semibold">Registre-se</span></p>
    </div>`; 
    
    document.getElementById('loginBtn').addEventListener('click', handleLogin); 
    document.getElementById('showSignup').addEventListener('click', showSignup); 
    document.getElementById('showForgotPassword').addEventListener('click', showForgotPassword);
}

function showSignup(){ 
    document.getElementById('authContainer').innerHTML = `<div class="p-8 max-w-md mx-auto mt-20 glass-card rounded-xl fade-in">
        <div class="text-center mb-6"><h1 class="text-3xl font-bold text-white">Registrar</h1></div>
        <input type="email" id="signupEmail" placeholder="Email" class="w-full mb-3 p-2 rounded-lg">
        <div class="relative mb-3">
            <input type="password" id="signupPass" placeholder="Senha (m√≠nimo 6 caracteres)" class="w-full p-2 rounded-lg pr-10">
            <button type="button" data-action="toggle-password" data-target="signupPass" class="password-toggle-btn">${eyeIconSvg}${eyeOffIconSvg}</button>
        </div>
        
        <div class="flex items-start space-x-3 my-4">
            <input id="termsCheckbox" type="checkbox" class="mt-1 h-4 w-4 rounded bg-gray-700 border-gray-500 text-cyan-500 focus:ring-cyan-600">
            <label for="termsCheckbox" class="text-sm text-gray-300">
                Eu entendo que este √© um app privado e concordo com o 
                <span id="showTerms" class="text-cyan-400 cursor-pointer hover:underline">"nosso combinado"</span> 
                sobre o uso dos meus dados.
            </label>
        </div>
        
        <p id="signupError" class="text-red-400 text-center text-sm mb-3 h-5"></p>
        <button id="signupBtn" class="w-full bg-green-500 py-2 rounded-lg font-bold btn-glow" disabled>Registrar</button>
        <p class="text-sm mt-3 text-center text-gray-400 cursor-pointer" id="backLogin">Voltar para o Login</p>
    </div>`; 
    
    const signupBtn = document.getElementById('signupBtn');
    const termsCheckbox = document.getElementById('termsCheckbox');
    
    termsCheckbox.addEventListener('change', () => {
        signupBtn.disabled = !termsCheckbox.checked;
    });
    
    document.getElementById('signupBtn').addEventListener('click', handleSignup); 
    document.getElementById('backLogin').addEventListener('click', showAuth); 
    document.getElementById('showTerms').addEventListener('click', showTermsModal); 
}

function showForgotPassword() {
    document.getElementById('authContainer').innerHTML = `<div class="p-8 max-w-md mx-auto mt-20 glass-card rounded-xl fade-in">
        <div class="text-center mb-6"><h1 class="text-3xl font-bold text-white">Recuperar Senha</h1></div>
        <p class="text-gray-300 text-sm text-center mb-4">Insira seu e-mail para enviarmos um link de redefini√ß√£o.</p>
        <input type="email" id="resetEmail" placeholder="Email" class="w-full mb-3 p-2 rounded-lg">
        <p id="resetMessage" class="text-center text-sm mb-3 h-5"></p>
        <button id="resetBtn" class="w-full bg-green-500 py-2 rounded-lg font-bold btn-glow">Enviar Link</button>
        <p class="text-sm mt-3 text-center text-gray-400 cursor-pointer" id="backLogin">Voltar para o Login</p>
    </div>`;
    document.getElementById('resetBtn').addEventListener('click', handleForgotPassword);
    document.getElementById('backLogin').addEventListener('click', showAuth);
}

async function handleLogin(){ const email = document.getElementById('loginEmail').value; const pass = document.getElementById('loginPass').value; const loginBtn = document.getElementById('loginBtn'); const errorElement = document.getElementById('loginError'); errorElement.textContent = ''; loginBtn.disabled = true; loginBtn.textContent = 'Entrando...'; try { await signInWithEmailAndPassword(auth, email, pass); } catch(e) { errorElement.textContent = 'Credenciais inv√°lidas.'; } finally { loginBtn.disabled = false; loginBtn.textContent = 'Entrar'; } }
async function handleSignup() { 
    const email = document.getElementById('signupEmail').value;
    const pass = document.getElementById('signupPass').value;
    const signupBtn = document.getElementById('signupBtn');
    const errorElement = document.getElementById('signupError');
    errorElement.textContent = '';
    signupBtn.disabled = true;
    signupBtn.textContent = 'Registrando...';
    if (pass.length < 6) {
        errorElement.textContent = 'A senha deve ter pelo menos 6 caracteres.';
        signupBtn.disabled = false;
        signupBtn.textContent = 'Registrar';
        return;
    }
    try {
        await createUserWithEmailAndPassword(auth, email, pass);
    } catch(e) {
        if (e.code === 'auth/email-already-in-use') { errorElement.textContent = 'Este email j√° est√° em uso.'; }
        else if (e.code === 'auth/invalid-email') { errorElement.textContent = 'Email inv√°lido.'; }
        else if (e.code === 'auth/weak-password') { errorElement.textContent = 'A senha √© muito fraca.'; }
        else { errorElement.textContent = 'Erro ao registrar. Tente novamente.'; }
    } finally {
        signupBtn.disabled = false;
        signupBtn.textContent = 'Registrar';
    }
}

async function handleForgotPassword() {
    const email = document.getElementById('resetEmail').value;
    const resetBtn = document.getElementById('resetBtn');
    const messageElement = document.getElementById('resetMessage');
    
    messageElement.textContent = '';
    resetBtn.disabled = true;
    resetBtn.textContent = 'Enviando...';

    try {
        await sendPasswordResetEmail(auth, email);
        messageElement.textContent = 'Email enviado! Verifique sua caixa de entrada.';
        messageElement.className = 'text-green-400 text-center text-sm mb-3 h-5';
    } catch(e) {
        if (e.code === 'auth/user-not-found' || e.code === 'auth/invalid-email') {
            messageElement.textContent = 'Email n√£o encontrado ou inv√°lido.';
        } else {
            messageElement.textContent = 'Erro ao enviar. Tente novamente.';
        }
        messageElement.className = 'text-red-400 text-center text-sm mb-3 h-5';
    } finally {
        resetBtn.disabled = false;
        resetBtn.textContent = 'Enviar Link';
    }
}


// --- MODAIS E A√á√ïES GLOBAIS ---
document.addEventListener('click', (e) => {
    const target = e.target.closest('button');
    if (!target) return;
    const { action, docId, items, target: targetId } = target.dataset;
    if (action === 'logout') signOut(auth);
    if (action === 'toggle-password') {
        const passwordInput = document.getElementById(targetId);
        const eyeIcon = target.querySelector('[data-icon="eye"]');
        const eyeOffIcon = target.querySelector('[data-icon="eye-off"]');
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            eyeIcon.classList.add('hidden');
            eyeOffIcon.classList.remove('hidden');
        } else {
            passwordInput.type = 'password';
            eyeIcon.classList.remove('hidden');
            eyeOffIcon.classList.add('hidden');
        }
    }
});

function showTermsModal() {
    const termsText = `
        <h3 class="font-bold text-lg text-white mb-2">Nosso "Combinado"</h3>
        <p class="text-sm text-gray-300 mb-4">Este √© um app privado, feito por [SEU NOME] para uso entre amigos.</p>
        <ul class="space-y-2 list-disc list-inside text-sm text-gray-300">
            <li>Seus dados (email e transa√ß√µes) s√£o salvos no Google Firebase, uma plataforma segura.</li>
            <li>As senhas s√£o criptografadas (nem eu consigo ver).</li>
            <li>As regras do banco de dados impedem que um usu√°rio veja os dados de outro.</li>
            <li>
                <strong>Importante:</strong> Como criador do app, eu tenho acesso de "administrador" ao console do Google. 
                Isso significa que, tecnicamente, eu posso ver seus dados financeiros se eu entrar no banco de dados.
            </li>
            <li class="font-semibold text-cyan-400">
                Ao se registrar, voc√™ confia que eu, [SEU NOME], jamais acessarei seus dados sem sua permiss√£o.
            </li>
            <li>Se um dia quiser sair, √© s√≥ me avisar. Eu removerei manually sua conta e todos os seus dados do sistema.</li>
        </ul>
    `;
    
    modalContainer.innerHTML = `<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-md relative fade-in glass-card">
            ${termsText}
            <div class="text-right mt-6">
                <button id="closeTerms" class="bg-cyan-600 py-2 px-5 rounded-lg font-bold text-white btn-glow">Entendi</button>
            </div>
        </div>
    </div>`;
    
    document.getElementById('closeTerms').addEventListener('click', () => {
        modalContainer.innerHTML = '';
    });
}


function showConfirmationModal(title, message, onConfirm) {
    modalContainer.innerHTML = `<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-2xl p-6 w-full max-w-sm relative fade-in glass-card"><h2 class="text-xl font-bold mb-2 text-white">${title}</h2><p class="text-gray-300 mb-6">${message}</p><div class="flex justify-end space-x-2"><button id="confirmCancel" class="bg-gray-600 hover:bg-gray-500 py-2 px-4 rounded-lg font-bold text-white transition-colors">Cancelar</button><button id="confirmAction" class="bg-red-500 py-2 px-4 rounded-lg font-bold text-white btn-glow">Confirmar</button></div></div></div>`;
    document.getElementById('confirmCancel').addEventListener('click', () => modalContainer.innerHTML = '');
    document.getElementById('confirmAction').addEventListener('click', () => { onConfirm(); modalContainer.innerHTML = ''; });
}

// --- Fun√ß√µes para "P√°ginas" de Modal ---

function closeTransactionPage() {
    modalPageContainer.innerHTML = '';
    modalPageContainer.classList.add('hidden');
    document.getElementById('appContainer').classList.remove('hidden');
}

function showTransactionModal(type, descInitial = ''){ 
    document.getElementById('appContainer').classList.add('hidden');
    
    modalPageContainer.innerHTML = `<div class="p-8 max-w-md mx-auto my-12 sm:my-20 glass-card rounded-xl fade-in">
        <h2 class="text-xl font-bold mb-4 text-white">${type==='receita'?'Adicionar Receita':'Adicionar Despesa'}</h2>
        <input id="transDesc" type="text" placeholder="Descri√ß√£o" class="w-full p-3 rounded-lg mb-3" value="${descInitial}"/>
        <input id="transAmount" type="number" placeholder="Valor (R$)" class="w-full p-3 rounded-lg mb-3"/>
        <div class="flex justify-end space-x-2">
            <button id="cancelBtn" class="bg-gray-600 hover:bg-gray-500 py-2 px-4 rounded-lg font-bold text-white transition-colors">Cancelar</button>
            <button id="saveBtn" class="bg-green-500 py-2 px-4 rounded-lg font-bold text-white btn-glow">Salvar</button>
        </div>
    </div>`; 
    
    modalPageContainer.classList.remove('hidden');
    window.scrollTo(0, 0);
    
    document.getElementById('cancelBtn').addEventListener('click', closeTransactionPage); 
    document.getElementById('saveBtn').addEventListener('click', async () => { 
        const saveBtn = document.getElementById('saveBtn'); 
        saveBtn.disabled = true; 
        try { 
            const userId = auth.currentUser.uid; 
            const desc = document.getElementById('transDesc').value.trim(); 
            const amount = parseFloat(document.getElementById('transAmount').value); 
            if(!desc || isNaN(amount) || amount <= 0) { 
                saveBtn.disabled = false; 
                return; 
            } 
            await addDoc(collection(db, 'users', userId, 'transactions'), { desc, amount, type, timestamp: serverTimestamp() }); 
            closeTransactionPage();
        } catch (err) { 
            console.error(err); 
            saveBtn.disabled = false; 
        } 
    }); 
}

// --- GEST√ÉO DE DADOS ---
let unsubscribeFromTransactions;

async function handleDeleteTransaction(docId) {
    showConfirmationModal('Excluir Transa√ß√£o', 'Tem a certeza de que deseja excluir esta transa√ß√£o? Esta a√ß√£o n√£o pode ser desfeita.', async () => {
        try {
            const userId = auth.currentUser.uid;
            await deleteDoc(doc(db, 'users', userId, 'transactions', docId));
        } catch (err) {
            console.error("Erro ao excluir transa√ß√£o:", err);
        }
    });
}

function updateFinanceChart(income, expense) {
    const ctx = document.getElementById('financeChart').getContext('2d');
    
    if (financeChartInstance) {
        financeChartInstance.destroy();
    }

    if (income === 0 && expense === 0) {
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#9ca3af';
        ctx.font = "16px 'Poppins'";
        ctx.fillText('Sem dados para este m√™s', ctx.canvas.width / 2, ctx.canvas.height / 2);
        ctx.restore();
        financeChartInstance = null;
        return;
    }

    financeChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Receitas', 'Despesas'],
            datasets: [{
                label: 'Movimenta√ß√µes',
                data: [income, expense],
                backgroundColor: [ 'rgba(52, 211, 153, 0.7)', 'rgba(248, 113, 113, 0.7)' ],
                borderColor: [ 'rgba(16, 185, 129, 1)', 'rgba(239, 68, 68, 1)' ],
                borderWidth: 1,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#e5e7eb',
                        padding: 20,
                        font: { size: 14, family: "'Poppins', sans-serif" }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) { label += ': '; }
                            if (context.parsed !== null) {
                                label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed);
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
}


function listenForTransactions() {
    if (unsubscribeFromTransactions) unsubscribeFromTransactions();
    if (!auth.currentUser) return;
    const userId = auth.currentUser.uid;
    const q = query(collection(db, 'users', userId, 'transactions'), orderBy('timestamp', 'desc'));
    
    unsubscribeFromTransactions = onSnapshot(q, (snapshot) => {
        let income = 0, expense = 0, transactionCount = 0;
        transactionHistory.innerHTML = '';
        
        const categoryTotals = {};
        
        const currentMonth = parseInt(monthFilter.value);
        const currentYear = parseInt(yearFilter.value);
        
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const docId = docSnap.id;
            if (!data.timestamp) return;
            const date = data.timestamp.toDate();
            
            if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
                transactionCount++;
                
                // --- Bloco para Hist√≥rico Detalhado ---
                const div = document.createElement('div');
                div.className = 'glass-card p-3 rounded-lg flex justify-between items-center fade-in';
                const formattedAmount = data.amount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                
                let actionButtons = `<button class="icon-btn" data-doc-id="${docId}" data-action="delete"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
                
                if (data.items) { 
                    actionButtons = `<button class="icon-btn view mr-2" 
                                        data-items='${JSON.stringify(data.items)}' 
                                        data-desc="${data.desc}"
                                        data-card="${data.cardName || ''}" 
                                        data-establishment="${data.establishment || ''}" 
                                        data-action="view-items">
                                     <svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                                     </button>` + actionButtons; 
                }
                
                let descriptionHtml = '';
                // SE TEM NOME DO CART√ÉO (Bradesco, etc), MOSTRA EM DESTAQUE
                if (data.cardName) {
                     descriptionHtml += `<p class="font-semibold text-cyan-400">${data.cardName}</p>`;
                     descriptionHtml += `<p class="text-sm text-gray-300">${data.desc}</p>`;
                } else {
                     descriptionHtml += `<p class="font-semibold">${data.desc}</p>`;
                }

                if (data.establishment) {
                    descriptionHtml += `<p class="text-xs text-gray-500 italic">${data.establishment}</p>`;
                }
                descriptionHtml += `<p class="text-[10px] text-gray-600">${date.toLocaleDateString('pt-BR')}</p>`;
                
                div.innerHTML = `<div>${descriptionHtml}</div>
                                 <div class="flex items-center">
                                    <span class="${data.type === 'receita' ? 'text-green-400' : 'text-red-400'} font-bold mr-4 text-sm sm:text-base">${formattedAmount}</span>
                                    <div>${actionButtons}</div>
                                 </div>`;
                transactionHistory.appendChild(div);
                
                // --- Bloco para Resumo Geral e Gr√°fico ---
                if (data.type === 'receita') income += data.amount; 
                else expense += data.amount;

                // --- L√≥gica para Resumo por Categoria ---
                const category = data.desc;
                const type = data.type;
                const amount = data.amount;
                
                if (!categoryTotals[category]) {
                    categoryTotals[category] = { income: 0, expense: 0 };
                }
                
                if (type === 'receita') {
                    categoryTotals[category].income += amount;
                } else {
                    categoryTotals[category].expense += amount;
                }
            }
        });
        
        // --- Renderiza Resumo Geral ---
        noTransactionsMsg.classList.toggle('hidden', transactionCount > 0);
        summaryIncome.textContent = income.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        summaryExpense.textContent = expense.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const balance = income - expense;
        summaryBalance.textContent = balance.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        summaryBalance.className = `text-2xl font-bold ${balance >= 0 ? 'text-cyan-400' : 'text-orange-400'}`;
        updateFinanceChart(income, expense);
        
        // --- Renderiza o novo Resumo por Categoria ---
        categorySummary.innerHTML = ''; // Limpa o resumo anterior
        let categoryCount = 0;
        const sortedCategories = Object.keys(categoryTotals).sort(); 
        
        // Limpa a mensagem de "sem resumo" antes de adicionar novos itens
        noSummaryMsg.classList.add('hidden');

        for (const category of sortedCategories) {
            const totals = categoryTotals[category];
            
            // Mostra apenas despesas
            if (totals.expense > 0) {
                categoryCount++;
                const formattedAmount = totals.expense.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                
                // Tenta extrair o nome base caso seja parcelado para pegar o √≠cone correto
                let baseCategoryName = category;
                if (category.includes('(') && category.includes('/')) {
                   baseCategoryName = category.split(' (')[0];
                }
                
                // Se o nome n√£o estiver na lista (ex: nome do item em 'Outro' ou 'Cart√µes'), tenta achar √≠cone gen√©rico ou do grupo
                let icon = getIconForCategory(baseCategoryName);
                if (icon === 'üí∏' && baseCategoryName !== 'Outro') {
                    // Tenta ver se originalmente era Cart√µes ou Outro, mas aqui n√£o temos essa info f√°cil.
                    // O getIconForCategory j√° tem fallback.
                }

                const div = document.createElement('div');
                div.className = 'glass-card p-4 rounded-xl flex flex-col items-center justify-center text-center h-28';
                div.innerHTML = `
                    <span class="text-3xl mb-2">${icon}</span>
                    <span class="font-semibold text-sm whitespace-normal leading-tight">${category}</span>
                    <span class="font-bold text-red-400 mt-1">${formattedAmount}</span>
                `;
                categorySummary.appendChild(div);
            }
        }
        
        // Mostra ou esconde a mensagem "Nenhuma categoria"
        if(categoryCount === 0) {
            noSummaryMsg.classList.remove('hidden');
        }

    }, (error) => {
        console.error("Erro ao ouvir transa√ß√µes:", error);
    });
}

function setupApp() {
    initializeAppDOMElements();
    
    document.querySelector('[data-action="show-income-modal"]').addEventListener('click', ()=> showTransactionModal('receita'));
    document.querySelector('[data-action="add-salary"]').addEventListener('click', ()=> showTransactionModal('receita', 'Sal√°rio'));
    
    quickAddContainer.innerHTML = '';
    // Classes do grid
    quickAddContainer.className = 'grid grid-cols-3 sm:grid-cols-5 md:grid-cols-7 lg:grid-cols-10 gap-4';
    
    quickAddItems.forEach(item => { 
        const btn = document.createElement('button'); 
        
        // --- ATUALIZA√á√ÉO AQUI ---
        // Adicionado 'items-center' ao bot√£o.
        btn.className = 'bg-gray-700 hover:bg-gray-600 rounded-lg p-2 flex flex-col justify-center items-center btn-glow h-28'; 
        // Removido 'w-full' do span de texto.
        btn.innerHTML = `<span class="text-3xl pointer-events-none">${item.icon}</span><span class="text-xs mt-2 pointer-events-none text-center whitespace-normal">${item.name}</span>`; 
        // --- FIM DA ATUALIZA√á√ÉO ---
        
        btn.dataset.action = item.action;
        btn.dataset.type = item.type;
        btn.dataset.name = item.name;
        btn.dataset.icon = item.icon;
        btn.dataset.entryType = item.entryType;
        quickAddContainer.appendChild(btn); 
    });

    quickAddContainer.addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        const { action, name, icon, entryType } = target.dataset;
        
        if (action === 'quick-expense') { 
            showItemizedExpenseModal(name, icon, entryType); 
        }
    });
    
    transactionHistory.addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        const { action, docId, items, desc, card, establishment } = target.dataset;
        if (action === 'delete') handleDeleteTransaction(docId);
        if (action === 'view-items') {
            showItemizedListModal(JSON.parse(items), desc, establishment, card);
        }
    });

    populateFilters();
    listenForTransactions();
}

function populateFilters() { 
    const now = new Date(); 
    monthFilter.innerHTML = '';
    yearFilter.innerHTML = '';
    for (let i = 0; i < 12; i++) { const monthName = new Date(now.getFullYear(), i, 1).toLocaleString('pt-BR', { month: 'long' }); const opt = document.createElement('option'); opt.value = i; opt.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1); if (i === now.getMonth()) opt.selected = true; monthFilter.appendChild(opt); } 
    for (let y = now.getFullYear(); y >= now.getFullYear() - 5; y--) { const opt = document.createElement('option'); opt.value = y; opt.textContent = y; if (y === now.getFullYear()) opt.selected = true; yearFilter.appendChild(opt); } 
    monthFilter.removeEventListener('change', listenForTransactions);
    yearFilter.removeEventListener('change', listenForTransactions);
    monthFilter.addEventListener('change', listenForTransactions); 
    yearFilter.addEventListener('change', listenForTransactions); 
}

// --- L√ìGICA DE DESPESA DETALHADA ---

function closeItemizedExpensePage() {
    modalPageContainer.innerHTML = '';
    modalPageContainer.classList.add('hidden');
    document.getElementById('appContainer').classList.remove('hidden');
}

function getPlaceholderForCategory(category) {
    const placeholderExamples = {
        'Supermercado': 'Ex: Arroz, Feij√£o, Leite',
        'Aluguel': 'Ex: Aluguel Mensal',
        'Energia': 'Ex: Conta de Luz',
        '√Ågua': 'Ex: Conta de √Ågua',
        'Internet': 'Ex: Mensalidade Internet',
        'Cart√µes': 'Ex: TV, Jantar, Uber', 
        'Combust√≠vel': 'Ex: Gasolina, Etanol', 
        'Farm√°cia': 'Ex: Dipirona, Band-aid',
        'Lazer': 'Ex: Cinema, Jantar',
        'Sa√∫de': 'Ex: Consulta M√©dica, Exame',
        'Educa√ß√£o': 'Ex: Mensalidade, Livro',
        'Comida': 'Ex: Pizza, Lanche',
        'Celular': 'Ex: Recarga, Conta',
        'Netflix': 'Ex: Assinatura Mensal',
        'YouTube': 'Ex: YouTube Premium',
        'Carro': 'Ex: Manuten√ß√£o, Pe√ßa',
        'Outro': 'Ex: Presente, D√≠vida'
    };
    return placeholderExamples[category] || 'Ex: Item';
}

function showItemizedExpenseModal(categoryName, categoryIcon, entryType) {
    let shoppingCart = [];
    document.getElementById('appContainer').classList.add('hidden');
    
    const isFullEntry = entryType === 'full';
    const placeholderText = getPlaceholderForCategory(categoryName);
    
    let inputsHtml = '';
    if (isFullEntry) {
        inputsHtml = `
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label for="item-type" class="text-sm font-medium text-gray-300">Tipo</label>
                    <select id="item-type" class="w-full p-2 rounded-lg mt-1">
                        <option value="unit">Unidade</option>
                        <option value="weight">Peso (kg)</option>
                    </select>
                </div>
                <div>
                    <label for="item-quantity" class="text-sm font-medium text-gray-300">Quantidade</label>
                    <input id="item-quantity" type="number" placeholder="1" class="w-full p-2 rounded-lg mt-1" step="any">
                </div>
            </div>
            <div>
                <label for="item-price" class="text-sm font-medium text-gray-300">Pre√ßo <span id="price-label-suffix">(por Unidade)</span></label>
                <input id="item-price" type="number" placeholder="1.99" class="w-full p-2 rounded-lg mt-1" step="any">
            </div>
        `;
    } else {
        inputsHtml = `
            <select id="item-type" class="hidden"><option value="unit" selected></option></select>
            <div class="grid grid-cols-2 gap-3">
                 <div>
                    <label for="item-quantity" class="text-sm font-medium text-gray-300">Quantidade</label>
                    <input id="item-quantity" type="number" value="1" class="w-full p-2 rounded-lg mt-1" step="1">
                </div>
                 <div>
                    <label for="item-price" class="text-sm font-medium text-gray-300">Pre√ßo Unit√°rio</label>
                    <input id="item-price" type="number" placeholder="1.99" class="w-full p-2 rounded-lg mt-1" step="any">
                </div>
            </div>
        `;
    }

    // --- NOVA L√ìGICA DE UI DE PARCELAMENTO + SELE√á√ÉO DE CART√ÉO ---
    let installmentHtml = '';
    let cardSelectionHtml = '';

    if (categoryName === 'Cart√µes') {
        const currentMonthIndex = new Date().getMonth();
        const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        
        let monthOptions = '';
        for(let i=0; i<12; i++) {
            // Calcula √≠ndices circulares para os pr√≥ximos 12 meses
            const mIndex = (currentMonthIndex + i) % 12;
            const mName = monthNames[mIndex];
            const isCurrent = i === 0 ? '(Atual)' : '';
            monthOptions += `<option value="${i}">${mName} ${isCurrent}</option>`;
        }

        installmentHtml = `
            <div id="installment-container" class="mt-4 p-3 bg-gray-700/30 rounded-lg border border-gray-600">
                <div class="flex items-center mb-2">
                    <input type="checkbox" id="is-installment" class="w-4 h-4 text-cyan-600 rounded focus:ring-cyan-500 bg-gray-700 border-gray-500">
                    <label for="is-installment" class="ml-2 text-sm font-medium text-gray-300">Compra Parcelada?</label>
                </div>
                <div id="installment-options" class="hidden grid grid-cols-2 gap-3 mt-2 animate-pulse-once">
                    <div>
                        <label class="text-xs text-gray-400">N¬∫ Parcelas</label>
                        <input type="number" id="installment-count" value="2" min="2" max="60" class="w-full p-2 rounded bg-gray-800 border border-gray-600 text-white text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">1¬™ Parcela em:</label>
                        <select id="installment-start-month" class="w-full p-2 rounded bg-gray-800 border border-gray-600 text-white text-sm">
                            ${monthOptions}
                        </select>
                    </div>
                </div>
            </div>
        `;

        // HTML para sele√ß√£o do Banco
        cardSelectionHtml = `
            <div class="mb-4">
                <label class="text-sm font-medium text-gray-300">Banco / Cart√£o</label>
                <select id="card-name-select" class="w-full p-2 rounded-lg mt-1">
                    <option value="Nubank">Nubank</option>
                    <option value="Bradesco">Bradesco</option>
                    <option value="Ita√∫">Ita√∫</option>
                    <option value="Santander">Santander</option>
                    <option value="Inter">Inter</option>
                    <option value="C6">C6</option>
                    <option value="Caixa">Caixa</option>
                    <option value="Banco do Brasil">Banco do Brasil</option>
                    <option value="Mercado Pago">Mercado Pago</option>
                    <option value="XP">XP</option>
                    <option value="Outro">Outro...</option>
                </select>
                <input id="card-name-other" type="text" placeholder="Nome do Cart√£o" class="w-full p-2 rounded-lg mt-2 hidden" />
            </div>
            <hr class="border-gray-700/50 mb-4">
        `;
    }
    // --- FIM DA NOVA L√ìGICA ---
    
    modalPageContainer.innerHTML = `<div class="bg-gray-800 rounded-2xl w-full max-w-lg glass-card mx-auto my-8 fade-in">
        
        <h2 class="text-xl font-bold p-4 border-b border-gray-700 text-white">${categoryIcon} ${categoryName}</h2>
        
        <div>
            <div class="p-4">
                
                ${cardSelectionHtml}

                <div class="space-y-3">
                    <div>
                        <label for="item-name" class="text-sm font-medium text-gray-300">Nome do Item</label>
                        <input id="item-name" type="text" placeholder="${placeholderText}" class="w-full p-2 rounded-lg mt-1">
                    </div>

                    <div>
                        <label for="item-establishment" class="text-sm font-medium text-gray-300">Estabelecimento (Opcional)</label>
                        <input id="item-establishment" type="text" placeholder="Ex: Nome da Loja" class="w-full p-2 rounded-lg mt-1">
                    </div>
                    
                    <hr class="border-gray-700/50">
                    
                    ${inputsHtml}
                    ${installmentHtml}
                    
                </div>
                <button id="add-item-btn" class="w-full bg-cyan-600 text-white font-bold py-2 rounded-lg btn-glow mt-4">Adicionar Item</button>
            </div>
            
            <div id="shopping-list" class="p-4 space-y-2 border-t border-b border-gray-700 max-h-80 overflow-y-auto">
                <p class="text-gray-500 text-center">Nenhum item adicionado.</p>
            </div>
        </div>

        <div class="p-4 space-y-3 border-t border-gray-700">
            <div class="flex justify-between items-center text-lg font-bold">
                <span class="text-gray-300">Total da Compra:</span>
                <span id="running-total" class="text-cyan-400">R$ 0,00</span>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="cancel-supermarket" class="bg-gray-600 py-2 px-4 rounded-lg font-bold text-white">Cancelar</button>
                <button id="save-supermarket" class="bg-green-500 py-2 px-4 rounded-lg font-bold text-white btn-glow">Salvar Despesa</button>
            </div>
        </div>
    </div>`;
    
    modalPageContainer.classList.remove('hidden');
    window.scrollTo(0, 0);

    // Toggle da visibilidade do parcelamento e do campo Outro Cart√£o
    if (categoryName === 'Cart√µes') {
        const checkbox = document.getElementById('is-installment');
        const optionsDiv = document.getElementById('installment-options');
        checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
                optionsDiv.classList.remove('hidden');
            } else {
                optionsDiv.classList.add('hidden');
            }
        });

        const cardSelect = document.getElementById('card-name-select');
        const cardOtherInput = document.getElementById('card-name-other');
        cardSelect.addEventListener('change', () => {
             if (cardSelect.value === 'Outro') {
                 cardOtherInput.classList.remove('hidden');
                 cardOtherInput.focus();
             } else {
                 cardOtherInput.classList.add('hidden');
             }
        });
    }
    
    const nameInput=document.getElementById('item-name'),typeSelect=document.getElementById('item-type'),quantityInput=document.getElementById('item-quantity'),priceInput=document.getElementById('item-price');
    
    if (isFullEntry) {
        const priceLabelSuffix = document.getElementById('price-label-suffix');
        typeSelect.addEventListener('change',()=>{
            if(typeSelect.value==='unit'){
                quantityInput.placeholder='1';
                priceInput.placeholder='1.99';
                priceLabelSuffix.textContent = '(por Unidade)';
            }else{
                quantityInput.placeholder='0.5';
                priceInput.placeholder='4.99';
                priceLabelSuffix.textContent = '(por KG)';
            }
        });
    }

    const renderCart=()=>{const listContainer=document.getElementById('shopping-list'),totalEl=document.getElementById('running-total');listContainer.innerHTML='';if(shoppingCart.length===0){listContainer.innerHTML='<p class="text-gray-500 text-center">Nenhum item adicionado.</p>';}let total=0;shoppingCart.forEach((item,index)=>{const itemDiv=document.createElement('div');itemDiv.className='bg-gray-700/50 p-2 rounded-lg flex justify-between items-center';itemDiv.innerHTML=`<div><p class="font-semibold">${item.name}</p><p class="text-xs text-gray-400">${item.desc}</p></div><div class="flex items-center"><span class="font-bold text-white mr-4">${item.total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</span><button data-index="${index}" class="icon-btn delete-item-btn"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>`;listContainer.appendChild(itemDiv);total+=item.total;});totalEl.textContent=total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});};
    
    document.getElementById('add-item-btn').addEventListener('click',()=>{
        const name=nameInput.value.trim();
        const type=typeSelect.value;
        const quantity=parseFloat(quantityInput.value);
        const price=parseFloat(priceInput.value);
        
        if(!name||isNaN(quantity)||quantity<=0||isNaN(price)||price<=0){
            const btn = document.getElementById('add-item-btn');
            const originalText = btn.textContent;
            btn.textContent = 'Preencha todos os campos!';
            btn.classList.add('bg-red-500');
            setTimeout(() => {
                 btn.textContent = originalText;
                 btn.classList.remove('bg-red-500');
            }, 2000);
            return;
        }
        
        let itemTotal=0,itemDesc='';
        if(type==='unit'){
            itemTotal=quantity*price;
            itemDesc=`${quantity} un. x ${price.toLocaleString('pt-BR',{style:'currency','currency':'BRL'})}`;
        } else {
            itemTotal=quantity*price;
            itemDesc=`${quantity.toFixed(3)} kg x ${price.toLocaleString('pt-BR',{style:'currency','currency':'BRL'})}/kg`;
        }
        
        shoppingCart.push({name,desc:itemDesc,total:itemTotal});
        renderCart();
        nameInput.value='';
        quantityInput.value = isFullEntry ? '' : '1';
        priceInput.value='';
        nameInput.focus();
    });
    
    document.getElementById('shopping-list').addEventListener('click',e=>{if(e.target.closest('.delete-item-btn')){const index=parseInt(e.target.closest('.delete-item-btn').dataset.index);shoppingCart.splice(index,1);renderCart();}});
    
    document.getElementById('cancel-supermarket').addEventListener('click', closeItemizedExpensePage);
    
    document.getElementById('save-supermarket').addEventListener('click',async()=>{
        if(shoppingCart.length===0)return;
        
        const saveBtn = document.getElementById('save-supermarket');
        saveBtn.disabled = true;
        saveBtn.innerText = "Salvando...";

        const establishment = document.getElementById('item-establishment').value.trim();
        const totalAmount=shoppingCart.reduce((sum,item)=>sum+item.total,0);
        
        // Captura o nome do cart√£o se for a categoria correta
        let selectedCardName = null;
        if (categoryName === 'Cart√µes') {
            const select = document.getElementById('card-name-select');
            if (select) {
                if (select.value === 'Outro') {
                    selectedCardName = document.getElementById('card-name-other').value.trim() || 'Cart√£o';
                } else {
                    selectedCardName = select.value;
                }
            }
        }

        // --- LOGICA DE PARCELAMENTO ---
        const isInstallment = document.getElementById('is-installment')?.checked;

        if (categoryName === 'Cart√µes' && isInstallment) {
            try {
                const parcels = parseInt(document.getElementById('installment-count').value);
                const startMonthOffset = parseInt(document.getElementById('installment-start-month').value);
                
                // Valida√ß√µes b√°sicas
                if (parcels < 2) throw new Error("M√≠nimo 2 parcelas");

                // Loop para criar N documentos
                for (let i = 0; i < parcels; i++) {
                    const parcelNumber = i + 1;
                    
                    // C√°lculo da data da parcela
                    const date = new Date();
                    date.setMonth(date.getMonth() + startMonthOffset + i);
                    
                    // Valor da parcela (arredondamento simples, centavos podem variar mas mantendo simples conforme solicitado)
                    const parcelValue = totalAmount / parcels;
                    
                    // Nome base do item principal (se houver Outro/Cart√µes usa o nome do 1¬∫ item)
                    let baseDesc = categoryName;
                    if ((categoryName === 'Outro' || categoryName === 'Cart√µes') && shoppingCart.length > 0) {
                        baseDesc = shoppingCart[0].name;
                    }
                    const finalDesc = `${baseDesc} (${parcelNumber}/${parcels})`;

                    // Cria√ß√£o dos items da parcela (ajustando o valor e nome para o detalhe da fatura)
                    const parcelItems = shoppingCart.map(item => ({
                        name: `${item.name} (${parcelNumber}/${parcels})`,
                        desc: item.desc, // Mant√©m descri√ß√£o original de qtd/peso
                        total: item.total / parcels // Valor proporcional da parcela
                    }));

                    await addDoc(collection(db,'users',auth.currentUser.uid,'transactions'),{
                        desc: finalDesc, 
                        amount: parcelValue,
                        type:'despesa',
                        timestamp: date, // Usa objeto Date JS para datas futuras
                        items: parcelItems,
                        establishment: establishment || null,
                        cardName: selectedCardName, // Salva o nome do Banco
                        installment: {
                            current: parcelNumber,
                            total: parcels,
                            totalValue: totalAmount
                        }
                    });
                }
            } catch (err) {
                console.error("Erro ao salvar parcelamento:", err);
            }
        } else {
            // --- L√ìGICA ORIGINAL (√Ä VISTA) ---
            let finalDesc = categoryName;
            if (categoryName === 'Outro' && shoppingCart.length > 0) {
                finalDesc = shoppingCart[0].name; 
            }
            if (categoryName === 'Cart√µes' && shoppingCart.length > 0) {
                // Se for cart√£o √† vista, usa o nome do primeiro item como descri√ß√£o para ficar mais claro
                finalDesc = shoppingCart[0].name;
            }

            await addDoc(collection(db,'users',auth.currentUser.uid,'transactions'),{
                desc: finalDesc, 
                amount:totalAmount,
                type:'despesa',
                timestamp:serverTimestamp(),
                items:shoppingCart,
                cardName: selectedCardName, // Salva o nome do Banco (se aplic√°vel)
                establishment: establishment || null
            });
        }
        
        saveBtn.disabled = false;
        closeItemizedExpensePage(); 
    });
}

function showItemizedListModal(items, desc, establishment, cardName) {
    let listHtml = '', total = 0;
    items.forEach(item => { 
        listHtml += `<div class="bg-gray-700/50 p-2 rounded-lg flex justify-between items-center"><p>${item.name} <span class="text-xs text-gray-400">(${item.desc})</span></p><p class="font-bold">${item.total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>`; 
        total += item.total; 
    });
    
    // Mostra o nome do cart√£o no t√≠tulo se existir, sen√£o usa a descri√ß√£o normal
    const titleText = cardName ? `${cardName} <span class="text-sm font-normal text-gray-400">| ${desc}</span>` : desc;

    modalContainer.innerHTML = `<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-2xl w-full max-w-md border border-gray-700">
            <div class="p-4 border-b border-gray-700">
                 <h2 class="text-xl font-bold text-white">üìã ${titleText}</h2>
                 ${establishment ? `<p class="text-cyan-400 mt-1">${establishment}</p>` : ''}
            </div>
            <div class="p-4 space-y-2 max-h-[60vh] overflow-y-auto">${listHtml}</div>
            <div class="p-4 border-t border-gray-700 flex justify-between items-center font-bold">
                <span>Total:</span><span>${total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
            </div>
            <div class="p-4 pt-0 text-center">
                <button id="close-item-list" class="bg-gray-600 py-2 px-6 rounded-lg text-white">Fechar</button>
            </div>
        </div>
    </div>`;
    document.getElementById('close-item-list').addEventListener('click', () => modalContainer.innerHTML = '');
}

// --- PONTO DE ENTRADA PRINCIPAL ---
onAuthStateChanged(auth, user => {
  if (unsubscribeFromTransactions) {
      unsubscribeFromTransactions();
      unsubscribeFromTransactions = null;
  }
  if (user) { 
      showApp(user); 
      setupApp();
  } 
  else { 
      showAuth();
      if (financeChartInstance) {
          financeChartInstance.destroy();
          financeChartInstance = null;
      }
      if (transactionHistory) transactionHistory.innerHTML = '<p id="no-transactions-msg" class="text-gray-500 text-center py-4">Nenhuma transa√ß√£o registada neste m√™s.</p>';
      if (categorySummary) categorySummary.innerHTML = '<p id="no-summary-msg" class="text-gray-500 text-center py-4 col-span-full">Nenhuma despesa para resumir este m√™s.</p>';
      
      if (summaryIncome) summaryIncome.textContent = 'R$ 0,00';
      if (summaryExpense) summaryExpense.textContent = 'R$ 0,00';
      if (summaryBalance) summaryBalance.textContent = 'R$ 0,00';
  }
});

</script>
</body>
</html>


