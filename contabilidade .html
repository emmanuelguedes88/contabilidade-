<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POF - Or√ßamento Familiar Divertido</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body{font-family:'Poppins',sans-serif;background-color:#111827;background-image:radial-gradient(circle at top left,#0e7490,#111827 40%),radial-gradient(circle at bottom right,#059669,#111827 50%);background-attachment:fixed;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;color:#e5e7eb;}
.hidden{display:none !important;}
@keyframes fadeIn{from{opacity:0;transform:translateY(-15px) scale(0.95);}to{opacity:1;transform:translateY(0) scale(1);}}
.fade-in{animation:fadeIn 0.5s ease-out forwards;}
.glass-card{background:rgba(31,41,55,0.6);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.1);box-shadow:0 8px 32px 0 rgba(0,0,0,0.37);}
.btn-glow{transition:all 0.3s ease;position:relative;overflow:hidden;}
.btn-glow:hover{box-shadow:0 0 15px 5px rgba(16,185,129,0.5);transform:translateY(-2px);}
.modal-scrollbar::-webkit-scrollbar{width:8px;}
.modal-scrollbar::-webkit-scrollbar-track{background:rgba(0,0,0,0.2);border-radius:10px;}
.modal-scrollbar::-webkit-scrollbar-thumb{background:rgba(13,148,136,0.7);border-radius:10px;}
.modal-scrollbar::-webkit-scrollbar-thumb:hover{background:#0d9488;}
.quick-add-card{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);transition:all 0.3s cubic-bezier(0.25,0.8,0.25,1);}
.quick-add-card:hover{transform:translateY(-8px);box-shadow:0 20px 25px -5px rgba(0,0,0,0.3),0 10px 10px -5px rgba(0,0,0,0.2);}
input,select{background-color:rgba(17,24,39,0.5);border:1px solid rgba(255,255,255,0.2);color:#fff;}
input:focus,select:focus{outline:none;border-color:#14b8a6;box-shadow:0 0 10px 2px rgba(20,184,166,0.5);}
input::placeholder{color:#9ca3af;}
select{appearance:none;}
.eye-icon{position:absolute;inset-y:0;right:0;display:flex;align-items:center;padding:0 0.75rem;color:#9ca3af;cursor:pointer;}
</style>
</head>
<body class="text-gray-200">
<!-- LOADER -->
<div id="initialLoader" class="fixed inset-0 bg-[#111827] flex flex-col items-center justify-center z-50">
<svg class="animate-spin h-10 w-10 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
<p id="loader-error" class="text-red-400 mt-4 hidden"></p>
</div>

<div id="authContainer"></div>

<div id="appContainer" class="hidden">
<header class="sticky top-0 z-30 bg-gray-900/50 backdrop-blur-lg">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex justify-between items-center py-4">
<div class="flex items-center space-x-3">
<span class="h-10 w-10 rounded-full border-2 border-cyan-400 flex items-center justify-center text-2xl">üöÄ</span>
<h1 class="text-2xl font-bold text-white tracking-wider">Meu Or√ßamento</h1>
</div>
<div class="flex items-center">
<span id="userEmail" class="text-gray-400 text-sm hidden sm:block mr-4"></span>
<button data-action="logout" class="rounded-full bg-red-500/80 py-2 px-4 text-sm font-semibold text-white btn-glow">Sair</button>
</div>
</div>
</div>
</header>

<main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
<div class="mb-8 space-y-6">
<div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4 glass-card p-3 rounded-2xl">
<label for="month-filter" class="font-semibold text-gray-300">Ver Or√ßamento de:</label>
<select id="month-filter" class="p-2 border-none rounded-lg"></select>
<select id="year-filter" class="p-2 border-none rounded-lg"></select>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
<div class="glass-card p-5 rounded-2xl flex items-center space-x-4"><div class="bg-green-500/20 p-3 rounded-full"><span class="text-3xl">üí∞</span></div><div><p class="text-sm text-gray-400">Receita do M√™s</p><p id="summaryIncome" class="text-2xl font-bold text-green-400">R$ 0,00</p></div></div>
<div class="glass-card p-5 rounded-2xl flex items-center space-x-4"><div class="bg-red-500/20 p-3 rounded-full"><span class="text-3xl">üí∏</span></div><div><p class="text-sm text-gray-400">Despesa do M√™s</p><p id="summaryExpense" class="text-2xl font-bold text-red-400">R$ 0,00</p></div></div>
<div class="glass-card p-5 rounded-2xl flex items-center space-x-4"><div class="bg-cyan-500/20 p-3 rounded-full"><span class="text-3xl">üè¶</span></div><div><p class="text-sm text-gray-400">Saldo do M√™s</p><p id="summaryBalance" class="text-2xl font-bold text-cyan-400">R$ 0,00</p></div></div>
</div>
</div>

<div class="mb-8">
<button data-action="show-income-modal" class="w-full mb-6 flex items-center justify-center space-x-3 bg-green-500 text-white font-bold py-4 px-4 rounded-xl btn-glow text-lg"><span class="text-2xl">‚ûï</span><span>Adicionar Receita</span></button>
<h3 class="text-xl font-bold text-white mb-4">Adicionar Despesa R√°pida</h3>
<div id="quick-add-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-9 gap-5"></div>
</div>

<div>
<h2 class="text-xl font-bold mb-4 text-white">Hist√≥rico de Transa√ß√µes do M√™s</h2>
<div id="transactionHistory" class="space-y-3">
<p id="no-transactions-msg" class="text-gray-500 text-center py-4 hidden">Nenhuma transa√ß√£o registada neste m√™s.</p>
</div>
</div>
</main>
</div>

<div id="modalContainer"></div>

<script type="module">
// ================== CONFIG ==================
const categories = {
'Receita': { icon: 'üí∞' }, 'Moradia': { icon: 'üè†' }, 'Alimenta√ß√£o': { icon: 'üõí' },
'Transporte': { icon: 'üöó' }, 'Sa√∫de': { icon: 'üíä' }, 'Lazer': { icon: 'üéÆ' },
'√Ågua': { icon: 'üíß' }, 'Energia': { icon: '‚ö°Ô∏è' }, 'Internet': { icon: 'üåê' }, 'Outros': { icon: 'üì¶' },
};
const formatCurrency = (v)=>(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

// ================== FIREBASE ==================
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = typeof firebaseconfig!=='undefined'?JSON.parse(firebaseconfig):{};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

function getTransactionsCollection(userId){return collection(db,'transactions',userId,'items');}
function onTransactionsUpdate(userId,year,month,callback){
    const start = new Date(Date.UTC(year,month,1));
    const end = new Date(Date.UTC(year,month+1,1));
    const q = query(getTransactionsCollection(userId), where('date','>=',start), where('date','<',end));
    return onSnapshot(q,snap=>{const txs=[];snap.forEach(doc=>txs.push({id:doc.id,...doc.data()}));callback(txs);});
}
async function addTransaction(appId,userId,data){await addDoc(getTransactionsCollection(userId),{...data,date:data.date,createdAt:serverTimestamp()});}

// ================== AUTH ==================
const authContainer = document.getElementById('authContainer');
const appContainer = document.getElementById('appContainer');
let currentUser = null;

function showAuth(){authContainer.innerHTML=`
<div class="min-h-screen flex items-center justify-center p-4">
<div class="glass-card p-8 rounded-2xl w-full max-w-md fade-in">
<h2 class="text-2xl font-bold text-white mb-6">Entrar / Cadastrar</h2>
<form id="loginForm" class="space-y-4">
<input type="email" id="loginEmail" placeholder="Email" required>
<div class="relative">
<input type="password" id="loginPassword" placeholder="Senha" required>
<span id="togglePwd" class="eye-icon">üëÅÔ∏è</span>
</div>
<div class="flex justify-between items-center">
<button type="submit" class="bg-cyan-500 text-white py-2 px-4 rounded-lg font-bold btn-glow">Entrar</button>
<button type="button" id="signupBtn" class="text-sm text-gray-300 underline">Cadastrar</button>
</div>
</form>
</div>
</div>`;

// toggle eye
document.getElementById('togglePwd').addEventListener('click',()=>{
const inp=document.getElementById('loginPassword');
inp.type=inp.type==='password'?'text':'password';
});

// login
document.getElementById('loginForm').addEventListener('submit', async e=>{
e.preventDefault();
try{const userCredential=await signInWithEmailAndPassword(auth,document.getElementById('loginEmail').value,document.getElementById('loginPassword').value);currentUser=userCredential.user;}catch(err){alert(err.message);}
});
// signup
document.getElementById('signupBtn').addEventListener('click', async ()=>{
try{const userCredential=await createUserWithEmailAndPassword(auth,document.getElementById('loginEmail').value,document.getElementById('loginPassword').value);currentUser=userCredential.user;}catch(err){alert(err.message);}
});
}

onAuthStateChanged(auth,user=>{
if(user){currentUser=user;authContainer.classList.add('hidden');appContainer.classList.remove('hidden');document.getElementById('userEmail').classList.remove('hidden');document.getElementById('userEmail').textContent=user.email;initApp();}
else{appContainer.classList.add('hidden');authContainer.classList.remove('hidden');showAuth();}
});

// ================== APP ==================
let txListener = null;
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();

function populateFilters(){
const monthSelect=document.getElementById('month-filter');
const yearSelect=document.getElementById('year-filter');
monthSelect.innerHTML='';yearSelect.innerHTML='';
for(let i=0;i<12;i++){monthSelect.appendChild(new Option(new Date(0,i).toLocaleString('pt-BR',{month:'long'}),i));}
for(let i=currentYear-5;i<=currentYear+1;i++){yearSelect.appendChild(new Option(i,i));}
monthSelect.value=currentMonth;yearSelect.value=currentYear;
monthSelect.addEventListener('change',()=>{currentMonth=parseInt(monthSelect.value);reloadTransactions();});
yearSelect.addEventListener('change',()=>{currentYear=parseInt(yearSelect.value);reloadTransactions();});
}

function initApp(){
populateFilters();
setupQuickAdd();
document.querySelector('[data-action="logout"]').addEventListener('click',()=>signOut(auth));
reloadTransactions();
}

function setupQuickAdd(){
const container=document.getElementById('quick-add-container');
container.innerHTML='';
Object.keys(categories).filter(c=>c!=='Receita').forEach(cat=>{
const btn=document.createElement('button');
btn.className='quick-add-card p-3 rounded-lg flex flex-col items-center justify-center text-white text-center';
btn.innerHTML=`<span class="text-2xl">${categories[cat].icon}</span><span class="mt-1 text-sm">${cat}</span>`;
btn.addEventListener('click',()=>showTransactionModal('Despesa',cat));
container.appendChild(btn);
});
}

// ================== TRANSACTIONS ==================
function reloadTransactions(){
if(txListener)txListener();
txListener=onTransactionsUpdate(currentUser.uid,currentYear,currentMonth,txs=>{
updateSummary(txs);
renderTransactions(txs);
});
}

function updateSummary(txs){
let income=0,expense=0;
txs.forEach(t=>{if(t.type==='Receita')income+=t.value;else expense+=t.value;});
document.getElementById('summaryIncome').textContent=formatCurrency(income);
document.getElementById('summaryExpense').textContent=formatCurrency(expense);
document.getElementById('summaryBalance').textContent=formatCurrency(income-expense);
}

function renderTransactions(txs){
const container=document.getElementById('transactionHistory');
container.innerHTML='';
if(!txs.length){document.getElementById('no-transactions-msg').classList.remove('hidden');return;}
document.getElementById('no-transactions-msg').classList.add('hidden');
txs.sort((a,b)=>b.date-a.date);
txs.forEach(tx=>{
const div=document.createElement('div');
div.className='glass-card p-4 rounded-xl flex justify-between items-center';
div.innerHTML=`<div><p class="font-bold">${tx.title}</p><p class="text-sm text-gray-400">${tx.category} - ${new Date(tx.date.seconds*1000).toLocaleDateString()}</p></div>
<div class="${tx.type==='Receita'?'text-green-400':'text-red-400'} font-bold">${formatCurrency(tx.value)}</div>`;
container.appendChild(div);
});
}

// ================== MODAL ==================
const modalContainer=document.getElementById('modalContainer');
function showTransactionModal(type='Receita',category='Receita'){
modalContainer.innerHTML=`
<div id="transactionModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 modal-scrollbar">
<div class="glass-card p-6 rounded-2xl w-11/12 max-w-md relative fade-in">
<h2 class="text-xl font-bold mb-4">${type==='Receita'?'Adicionar Receita':'Adicionar Despesa'}</h2>
<form id="transactionForm" class="space-y-4">
<input type="text" id="txTitle" placeholder="T√≠tulo" class="w-full p-2 rounded-lg" required>
<input type="number" step="0.01" id="txValue" placeholder="Valor" class="w-full p-2 rounded-lg" required>
<select id="txCategory" class="w-full p-2 rounded-lg"></select>
<input type="date" id="txDate" class="w-full p-2 rounded-lg" value="${new Date().toISOString().split('T')[0]}">
<div class="flex justify-end space-x-3">
<button type="button" id="cancelBtn" class="bg-gray-600 px-4 py-2 rounded-lg">Cancelar</button>
<button type="submit" class="bg-cyan-500 px-4 py-2 rounded-lg text-white font-bold">${type==='Receita'?'Adicionar':'Salvar'}</button>
</div>
</form>
</div>
</div>`;
const catSelect=document.getElementById('txCategory');catSelect.innerHTML='';
Object.keys(categories).forEach(c=>{const opt=new Option(c,c);if(c===category)opt.selected=true;catSelect.appendChild(opt);});
document.getElementById('cancelBtn').addEventListener('click',()=>modalContainer.innerHTML='');
document.getElementById('transactionForm').addEventListener('submit',async e=>{
e.preventDefault();
const title=document.getElementById('txTitle').value.trim();
const value=parseFloat(document.getElementById('txValue').value);
const category=document.getElementById('txCategory').value;
const date=new Date(document.getElementById('txDate').value);
if(!title||!value||!category||!date)return alert('Preencha todos os campos');
try{await addTransaction('appId',currentUser.uid,{title,value,type,category,date});modalContainer.innerHTML='';}catch(err){alert('Erro: '+err.message);}
});
}

// quick add receita
document.querySelector('[data-action="show-income-modal"]').addEventListener('click',()=>showTransactionModal('Receita','Receita'));
</script>
</body>
</html>
